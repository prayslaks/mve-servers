<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVE Resource Server - Admin</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 { color: #333; }
        .section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h2 { margin-top: 0; color: #555; }
        input, button {
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        input[type="text"], input[type="password"] {
            width: 100%;
            box-sizing: border-box;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            width: 100%;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        #result {
            margin-top: 10px;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        .audio-list {
            list-style: none;
            padding: 0;
        }
        .audio-list li {
            padding: 10px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .audio-list li:last-child { border-bottom: none; }
        .play-btn {
            width: auto;
            padding: 5px 10px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>MVE Resource Server - Admin</h1>

    <!-- 로그인 -->
    <div class="section">
        <h2>1. 로그인</h2>
        <input type="text" id="username" placeholder="Username">
        <input type="password" id="password" placeholder="Password">
        <input type="text" id="loginServer" placeholder="Login Server URL" value="http://localhost:3000">
        <input type="text" id="resourceServer" placeholder="Resource Server URL" value="http://localhost:3001">
        <button onclick="login()">로그인</button>
        <p id="tokenStatus"></p>
    </div>

    <!-- 음원 업로드 -->
    <div class="section">
        <h2>2. 음원 업로드</h2>
        <input type="file" id="audioFile" accept=".aac,.m4a,.mp3,.wav">
        <input type="text" id="title" placeholder="제목 (필수)">
        <input type="text" id="artist" placeholder="아티스트 (선택)">
        <input type="number" id="duration" placeholder="재생시간 (초, 선택)">
        <button onclick="uploadAudio()" id="uploadBtn" disabled>업로드</button>
    </div>

    <!-- 음원 목록 -->
    <div class="section">
        <h2>3. 음원 목록</h2>
        <button onclick="loadAudioList()" id="listBtn" disabled>목록 조회</button>
        <ul class="audio-list" id="audioList"></ul>
    </div>

    <!-- 결과 -->
    <div class="section">
        <h2>결과</h2>
        <div id="result">결과가 여기에 표시됩니다.</div>
    </div>

    <!-- 오디오 플레이어 -->
    <audio id="audioPlayer" controls style="width: 100%; margin-top: 10px; display: none;"></audio>

    <script>
        let token = null;

        function getLoginServer() {
            return document.getElementById('loginServer').value;
        }

        function getResourceServer() {
            return document.getElementById('resourceServer').value;
        }

        function showResult(data, isError = false) {
            const result = document.getElementById('result');
            result.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            result.className = isError ? 'error' : '';
        }

        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;

            try {
                const response = await fetch(`${getLoginServer()}/api/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (data.token) {
                    token = data.token;
                    document.getElementById('tokenStatus').innerHTML = '<span class="success">로그인 성공!</span>';
                    document.getElementById('uploadBtn').disabled = false;
                    document.getElementById('listBtn').disabled = false;
                    showResult(data);
                } else {
                    showResult(data, true);
                }
            } catch (error) {
                showResult(`로그인 실패: ${error.message}`, true);
            }
        }

        async function uploadAudio() {
            if (!token) {
                showResult('먼저 로그인하세요.', true);
                return;
            }

            const fileInput = document.getElementById('audioFile');
            const title = document.getElementById('title').value;
            const artist = document.getElementById('artist').value;
            const duration = document.getElementById('duration').value;

            if (!fileInput.files[0]) {
                showResult('파일을 선택하세요.', true);
                return;
            }

            if (!title) {
                showResult('제목을 입력하세요.', true);
                return;
            }

            const formData = new FormData();
            formData.append('audio', fileInput.files[0]);
            formData.append('title', title);
            if (artist) formData.append('artist', artist);
            if (duration) formData.append('duration', duration);

            try {
                document.getElementById('uploadBtn').disabled = true;
                document.getElementById('uploadBtn').textContent = '업로드 중...';

                const response = await fetch(`${getResourceServer()}/api/audio/upload`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` },
                    body: formData
                });

                const data = await response.json();
                showResult(data, !data.success);

                if (data.success) {
                    // 폼 초기화
                    fileInput.value = '';
                    document.getElementById('title').value = '';
                    document.getElementById('artist').value = '';
                    document.getElementById('duration').value = '';
                    // 목록 새로고침
                    loadAudioList();
                }
            } catch (error) {
                showResult(`업로드 실패: ${error.message}`, true);
            } finally {
                document.getElementById('uploadBtn').disabled = false;
                document.getElementById('uploadBtn').textContent = '업로드';
            }
        }

        async function loadAudioList() {
            if (!token) {
                showResult('먼저 로그인하세요.', true);
                return;
            }

            try {
                const response = await fetch(`${getResourceServer()}/api/audio/list`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                showResult(data, !data.success);

                if (data.success) {
                    const list = document.getElementById('audioList');
                    list.innerHTML = '';

                    if (data.audio_files.length === 0) {
                        list.innerHTML = '<li>등록된 음원이 없습니다.</li>';
                        return;
                    }

                    data.audio_files.forEach(audio => {
                        const li = document.createElement('li');
                        li.innerHTML = `
                            <div>
                                <strong>${audio.title}</strong>
                                ${audio.artist ? `- ${audio.artist}` : ''}
                                <br>
                                <small>ID: ${audio.id} | ${audio.format} | ${(audio.file_size / 1024 / 1024).toFixed(2)} MB</small>
                            </div>
                            <button class="play-btn" onclick="playAudio(${audio.id})">재생</button>
                        `;
                        list.appendChild(li);
                    });
                }
            } catch (error) {
                showResult(`목록 조회 실패: ${error.message}`, true);
            }
        }

        async function playAudio(id) {
            if (!token) {
                showResult('먼저 로그인하세요.', true);
                return;
            }

            try {
                const response = await fetch(`${getResourceServer()}/api/audio/stream/${id}`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const data = await response.json();
                const player = document.getElementById('audioPlayer');

                if (data.success && data.stream_url) {
                    let audioUrl = data.stream_url;

                    // 상대 경로인 경우 (로컬) - fetch로 blob 가져와서 재생
                    if (audioUrl.startsWith('/')) {
                        const audioResponse = await fetch(`${getResourceServer()}${audioUrl}`, {
                            headers: { 'Authorization': `Bearer ${token}` }
                        });
                        const blob = await audioResponse.blob();
                        audioUrl = URL.createObjectURL(blob);
                    }

                    player.src = audioUrl;
                    player.style.display = 'block';
                    player.play();
                    showResult(`재생 중: ${data.audio_file.title}`);
                } else {
                    showResult(`스트리밍 실패: ${data.message || 'Unknown error'}`, true);
                }
            } catch (error) {
                showResult(`재생 실패: ${error.message}`, true);
            }
        }
    </script>
</body>
</html>
