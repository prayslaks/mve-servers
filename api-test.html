<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MVE API Tester</title>
    <style>
        * { box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        h1 { color: #333; margin-bottom: 20px; }
        .section { background: white; padding: 20px; margin-bottom: 20px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .section h2 { margin-top: 0; color: #444; border-bottom: 2px solid #4CAF50; padding-bottom: 10px; }
        .api-group { margin-bottom: 15px; padding: 15px; background: #f9f9f9; border-radius: 4px; }
        .api-group h3 { margin: 0 0 10px 0; font-size: 14px; color: #666; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; }
        .input-group input, .input-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px; }
        .input-group textarea { height: 80px; resize: vertical; }
        button { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; margin-right: 5px; margin-bottom: 5px; }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-warning { background: #ff9800; color: white; }
        button:hover { opacity: 0.9; }
        .response { margin-top: 10px; padding: 10px; background: #263238; color: #aed581; border-radius: 4px; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .token-display { background: #fff3e0; padding: 10px; border-radius: 4px; margin-bottom: 15px; word-break: break-all; font-size: 12px; }
        .status { padding: 4px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .status-success { background: #c8e6c9; color: #2e7d32; }
        .status-error { background: #ffcdd2; color: #c62828; }
        .flex { display: flex; gap: 10px; }
        .flex > * { flex: 1; }
        .server-config { display: flex; gap: 10px; margin-bottom: 15px; }
        .server-config input { flex: 1; }
        .example-box {
            background: #e8f5e9;
            padding: 8px 12px;
            border-radius: 4px;
            margin-top: 5px;
            font-family: monospace;
            font-size: 12px;
            cursor: pointer;
            border: 1px solid #a5d6a7;
            position: relative;
        }
        .example-box:hover {
            background: #c8e6c9;
        }
        .example-box::before {
            content: 'üìã Click to copy: ';
            color: #2e7d32;
            font-weight: bold;
        }
        .example-box.copied::after {
            content: '‚úì Copied!';
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: #2e7d32;
            color: white;
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 11px;
            animation: fadeOut 2s forwards;
        }
        @keyframes fadeOut {
            0%, 50% { opacity: 1; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>MVE API Tester</h1>

        <!-- Server Configuration -->
        <div class="section">
            <h2>Server Configuration</h2>
            <div class="server-config">
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Login Server URL</label>
                    <input type="text" id="loginServerUrl" value="http://localhost:3000">
                </div>
                <div class="input-group" style="margin-bottom: 0;">
                    <label>Resource Server URL</label>
                    <input type="text" id="resourceServerUrl" value="http://localhost:3001">
                </div>
            </div>
            <div class="token-display">
                <strong>Current JWT Token:</strong><br>
                <span id="currentToken">No token</span>
            </div>
        </div>

        <!-- Login Server APIs -->
        <div class="section">
            <h2>Login Server APIs</h2>

            <!-- Health Check -->
            <div class="api-group">
                <h3>GET /health - Health Check</h3>
                <button class="btn-primary" onclick="testLoginHealth()">Test Health</button>
                <div class="response" id="healthResponse"></div>
            </div>

            <!-- Check Email -->
            <div class="api-group">
                <h3>POST /api/auth/check-email - Check Email Availability</h3>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="checkEmail" placeholder="test@example.com">
                </div>
                <button class="btn-primary" onclick="checkEmail()">Check Email</button>
                <div class="response" id="checkEmailResponse"></div>
            </div>

            <!-- Send Verification -->
            <div class="api-group">
                <h3>POST /api/auth/send-verification - Send Verification Code</h3>
                <div class="input-group">
                    <label>Email</label>
                    <input type="email" id="verifyEmail" placeholder="test@example.com">
                </div>
                <button class="btn-warning" onclick="sendVerification()">Send Code</button>
                <div class="response" id="sendVerificationResponse"></div>
            </div>

            <!-- Verify Code -->
            <div class="api-group">
                <h3>POST /api/auth/verify-code - Verify Code</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="verifyCodeEmail" placeholder="test@example.com">
                    </div>
                    <div class="input-group">
                        <label>Code (6 digits)</label>
                        <input type="text" id="verifyCode" placeholder="123456">
                    </div>
                </div>
                <button class="btn-primary" onclick="verifyCode()">Verify Code</button>
                <div class="response" id="verifyCodeResponse"></div>
            </div>

            <!-- Signup -->
            <div class="api-group">
                <h3>POST /api/auth/signup - Sign Up</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" id="signupUsername" placeholder="testuser">
                    </div>
                    <div class="input-group">
                        <label>Email</label>
                        <input type="email" id="signupEmail" placeholder="test@example.com">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="signupPassword" placeholder="password123">
                    </div>
                </div>
                <button class="btn-primary" onclick="signup()">Sign Up</button>
                <div class="response" id="signupResponse"></div>
            </div>

            <!-- Login -->
            <div class="api-group">
                <h3>POST /api/auth/login - Login</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Username</label>
                        <input type="text" id="loginUsername" placeholder="testuser">
                    </div>
                    <div class="input-group">
                        <label>Password</label>
                        <input type="password" id="loginPassword" placeholder="password123">
                    </div>
                </div>
                <button class="btn-secondary" onclick="login()">Login & Save Token</button>
                <div class="response" id="loginResponse"></div>
            </div>

            <!-- Profile -->
            <div class="api-group">
                <h3>GET /api/auth/profile - Get Profile (JWT Required)</h3>
                <button class="btn-primary" onclick="getProfile()">Get Profile</button>
                <div class="response" id="profileResponse"></div>
            </div>

            <!-- Logout -->
            <div class="api-group">
                <h3>POST /api/auth/logout - Logout (JWT Required)</h3>
                <button class="btn-warning" onclick="logout()">Logout</button>
                <div class="response" id="logoutResponse"></div>
            </div>

            <!-- Withdraw -->
            <div class="api-group">
                <h3>DELETE /api/auth/withdraw - Delete Account (JWT Required)</h3>
                <div class="input-group">
                    <label>Password (ÌòÑÏû¨ ÎπÑÎ∞ÄÎ≤àÌò∏ ÌôïÏù∏)</label>
                    <input type="password" id="withdrawPassword" placeholder="current password">
                </div>
                <button class="btn-danger" onclick="withdraw()">Delete Account</button>
                <div class="response" id="withdrawResponse"></div>
            </div>
        </div>

        <!-- Resource Server APIs -->
        <div class="section">
            <h2>Resource Server APIs</h2>

            <!-- Health Check -->
            <div class="api-group">
                <h3>GET /health - Health Check</h3>
                <button class="btn-primary" onclick="testResourceHealth()">Test Health</button>
                <div class="response" id="resourceHealthResponse"></div>
            </div>

            <!-- Audio List -->
            <div class="api-group">
                <h3>GET /api/audio/list - Get Audio List (JWT Required)</h3>
                <button class="btn-primary" onclick="getAudioList()">Get Audio List</button>
                <div class="response" id="audioListResponse"></div>
            </div>

            <!-- Audio Info -->
            <div class="api-group">
                <h3>GET /api/audio/:id - Get Audio Info (JWT Required)</h3>
                <div class="input-group">
                    <label>Audio ID</label>
                    <input type="number" id="audioId" placeholder="Enter Audio ID">
                </div>
                <button class="btn-primary" onclick="getAudioInfo()">Get Audio Info</button>
                <div class="response" id="audioInfoResponse"></div>
            </div>

            <!-- Audio Search -->
            <div class="api-group">
                <h3>GET /api/audio/search/:query - Search Audio (JWT Required)</h3>
                <div class="input-group">
                    <label>Search Query</label>
                    <input type="text" id="audioSearchQuery" placeholder="song name">
                </div>
                <button class="btn-primary" onclick="searchAudio()">Search Audio</button>
                <div class="response" id="audioSearchResponse"></div>
            </div>

            <!-- Audio Upload -->
            <div class="api-group">
                <h3>POST /api/audio/upload - Upload Audio (JWT Required)</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Title</label>
                        <input type="text" id="uploadTitle" placeholder="Song Title">
                    </div>
                    <div class="input-group">
                        <label>Artist</label>
                        <input type="text" id="uploadArtist" placeholder="Artist Name">
                    </div>
                </div>
                <div class="input-group">
                    <label>Audio File (AAC, M4A, MP3, WAV)</label>
                    <input type="file" id="uploadAudioFile" accept=".aac,.m4a,.mp3,.wav">
                </div>
                <button class="btn-primary" onclick="uploadAudio()">Upload Audio</button>
                <div class="response" id="uploadAudioResponse"></div>
            </div>

            <!-- Audio Stream -->
            <div class="api-group">
                <h3>GET /api/audio/stream/:id - Stream Audio (JWT Required)</h3>
                <div class="input-group">
                    <label>Audio ID</label>
                    <input type="number" id="streamAudioId" placeholder="Enter Audio ID">
                </div>
                <button class="btn-secondary" onclick="streamAudio()">Get Stream URL</button>
                <div class="response" id="streamAudioResponse"></div>
            </div>

            <!-- Model List -->
            <div class="api-group">
                <h3>GET /api/models/list - Get Model List (JWT Required)</h3>
                <button class="btn-primary" onclick="getModelList()">Get Model List</button>
                <div class="response" id="modelListResponse"></div>
            </div>

            <!-- Model Info -->
            <div class="api-group">
                <h3>GET /api/models/:id - Get Model Info (JWT Required)</h3>
                <div class="input-group">
                    <label>Model ID</label>
                    <input type="number" id="modelId" placeholder="1">
                </div>
                <button class="btn-primary" onclick="getModelInfo()">Get Model Info</button>
                <div class="response" id="modelInfoResponse"></div>
            </div>

            <!-- Register Model -->
            <div class="api-group">
                <h3>POST /api/models/register - Register Model (JWT Required)</h3>
                <div class="input-group">
                    <label>Model Data (JSON)</label>
                    <textarea id="registerModelData">{
    "name": "My Model",
    "file_path": "/models/my-model.glb",
    "description": "Test model"
}</textarea>
                </div>
                <button class="btn-primary" onclick="registerModel()">Register Model</button>
                <div class="response" id="registerModelResponse"></div>
            </div>

            <!-- Update Model -->
            <div class="api-group">
                <h3>PUT /api/models/:id - Update Model (JWT Required)</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Model ID</label>
                        <input type="number" id="updateModelId" placeholder="1">
                    </div>
                </div>
                <div class="input-group">
                    <label>Update Data (JSON)</label>
                    <textarea id="updateModelData">{
    "name": "Updated Model",
    "description": "Updated description"
}</textarea>
                </div>
                <button class="btn-warning" onclick="updateModel()">Update Model</button>
                <div class="response" id="updateModelResponse"></div>
            </div>

            <!-- Delete Model -->
            <div class="api-group">
                <h3>DELETE /api/models/:id - Delete Model (JWT Required)</h3>
                <div class="input-group">
                    <label>Model ID</label>
                    <input type="number" id="deleteModelId" placeholder="1">
                </div>
                <button class="btn-danger" onclick="deleteModel()">Delete Model</button>
                <div class="response" id="deleteModelResponse"></div>
            </div>
        </div>

        <!-- Concert APIs -->
        <div class="section">
            <h2>Concert APIs (ÏΩòÏÑúÌä∏ Í∏∞Îä•)</h2>

            <!-- Create Concert -->
            <div class="api-group">
                <h3>POST /api/concert/create - Create Concert (JWT Required)</h3>
                <div class="input-group">
                    <label>ÏΩòÏÑúÌä∏ Ïù¥Î¶Ñ</label>
                    <input type="text" id="concertName" placeholder="My First Concert">
                </div>
                <div class="input-group">
                    <label>ÏµúÎåÄ Í¥ÄÍ∞ù Ïàò (Optional)</label>
                    <input type="number" id="concertMaxAudience" placeholder="100">
                </div>
                <div class="input-group">
                    <label>Songs JSON (Optional)</label>
                    <textarea id="concertSongsJson" placeholder='[{"songNum":1,"audioId":1,"streamUrl":"/api/audio/stream/1","stageDirectionId":10}]'></textarea>
                    <div class="example-box" onclick="copyToInput('concertSongsJson', '[{&quot;songNum&quot;:1,&quot;audioId&quot;:1,&quot;streamUrl&quot;:&quot;/api/audio/stream/1&quot;,&quot;stageDirectionId&quot;:10}]', this)">[{"songNum":1,"audioId":1,"streamUrl":"/api/audio/stream/1","stageDirectionId":10}]</div>
                </div>
                <div class="input-group">
                    <label>Accessories JSON (Optional)</label>
                    <textarea id="concertAccessoriesJson" placeholder='[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]'></textarea>
                    <div class="example-box" onclick="copyToInput('concertAccessoriesJson', '[{&quot;socketName&quot;:&quot;head_socket&quot;,&quot;relativeLocation&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;z&quot;:10},&quot;relativeRotation&quot;:{&quot;pitch&quot;:0,&quot;yaw&quot;:0,&quot;roll&quot;:0},&quot;modelUrl&quot;:&quot;/models/hat.glb&quot;}]', this)">[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]</div>
                </div>
                <button class="btn-primary" onclick="createConcert()">Create Concert</button>
                <div class="response" id="createConcertResponse"></div>
            </div>

            <!-- List Concerts -->
            <div class="api-group">
                <h3>GET /api/concert/list - List Active Concerts (JWT Required)</h3>
                <button class="btn-primary" onclick="listConcerts()">List Concerts</button>
                <div class="response" id="listConcertsResponse"></div>
            </div>

            <!-- Join Concert -->
            <div class="api-group">
                <h3>POST /api/concert/:roomId/join - Join Concert (JWT Required)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="joinRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <button class="btn-secondary" onclick="joinConcert()">Join Concert</button>
                <div class="response" id="joinConcertResponse"></div>
            </div>

            <!-- Get Concert Info -->
            <div class="api-group">
                <h3>GET /api/concert/:roomId/info - Get Concert Info (JWT Required)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="infoRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <button class="btn-primary" onclick="getConcertInfo()">Get Concert Info</button>
                <div class="response" id="concertInfoResponse"></div>
            </div>

            <!-- Add Song -->
            <div class="api-group">
                <h3>POST /api/concert/:roomId/songs/add - Add Song (JWT Required, Studio Only)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="addSongRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <div class="flex">
                    <div class="input-group">
                        <label>Song Number</label>
                        <input type="number" id="addSongNum" placeholder="1">
                    </div>
                    <div class="input-group">
                        <label>Audio ID</label>
                        <input type="number" id="addSongAudioId" placeholder="1">
                    </div>
                </div>
                <div class="flex">
                    <div class="input-group">
                        <label>Stream URL</label>
                        <input type="text" id="addSongStreamUrl" placeholder="/api/audio/stream/1">
                    </div>
                    <div class="input-group">
                        <label>Stage Direction ID</label>
                        <input type="number" id="addSongStageDirectionId" placeholder="10">
                    </div>
                </div>
                <button class="btn-primary" onclick="addSong()">Add Song</button>
                <div class="response" id="addSongResponse"></div>
            </div>

            <!-- Remove Song -->
            <div class="api-group">
                <h3>DELETE /api/concert/:roomId/songs/:songNum - Remove Song (JWT Required, Studio Only)</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Room ID</label>
                        <input type="text" id="removeSongRoomId" placeholder="concert_1234567890_abc123">
                    </div>
                    <div class="input-group">
                        <label>Song Number</label>
                        <input type="number" id="removeSongNum" placeholder="1">
                    </div>
                </div>
                <button class="btn-danger" onclick="removeSong()">Remove Song</button>
                <div class="response" id="removeSongResponse"></div>
            </div>

            <!-- Change Song -->
            <div class="api-group">
                <h3>POST /api/concert/:roomId/songs/change - Change Current Song (JWT Required, Studio Only)</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Room ID</label>
                        <input type="text" id="changeSongRoomId" placeholder="concert_1234567890_abc123">
                    </div>
                    <div class="input-group">
                        <label>Song Number</label>
                        <input type="number" id="changeSongNum" placeholder="2">
                    </div>
                </div>
                <button class="btn-warning" onclick="changeSong()">Change Song</button>
                <div class="response" id="changeSongResponse"></div>
            </div>

            <!-- Get Current Song -->
            <div class="api-group">
                <h3>GET /api/concert/:roomId/current-song - Get Current Song (JWT Required, Audience)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="currentSongRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <button class="btn-secondary" onclick="getCurrentSong()">Get Current Song</button>
                <div class="response" id="currentSongResponse"></div>
            </div>

            <!-- Add Accessory -->
            <div class="api-group">
                <h3>POST /api/concert/:roomId/accessories/add - Add Accessory (JWT Required, Studio Only)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="addAccessoryRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <div class="input-group">
                    <label>Socket Name</label>
                    <input type="text" id="addAccessorySocketName" placeholder="head_socket">
                </div>
                <div class="flex">
                    <div class="input-group">
                        <label>Location X</label>
                        <input type="number" id="addAccessoryLocationX" placeholder="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Location Y</label>
                        <input type="number" id="addAccessoryLocationY" placeholder="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Location Z</label>
                        <input type="number" id="addAccessoryLocationZ" placeholder="10" step="0.01">
                    </div>
                </div>
                <div class="flex">
                    <div class="input-group">
                        <label>Rotation Pitch</label>
                        <input type="number" id="addAccessoryRotationPitch" placeholder="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Rotation Yaw</label>
                        <input type="number" id="addAccessoryRotationYaw" placeholder="0" step="0.01">
                    </div>
                    <div class="input-group">
                        <label>Rotation Roll</label>
                        <input type="number" id="addAccessoryRotationRoll" placeholder="0" step="0.01">
                    </div>
                </div>
                <div class="input-group">
                    <label>Model URL</label>
                    <input type="text" id="addAccessoryModelUrl" placeholder="/models/hat.glb">
                </div>
                <button class="btn-primary" onclick="addAccessory()">Add Accessory</button>
                <div class="response" id="addAccessoryResponse"></div>
            </div>

            <!-- Remove Accessory -->
            <div class="api-group">
                <h3>DELETE /api/concert/:roomId/accessories/:index - Remove Accessory (JWT Required, Studio Only)</h3>
                <div class="flex">
                    <div class="input-group">
                        <label>Room ID</label>
                        <input type="text" id="removeAccessoryRoomId" placeholder="concert_1234567890_abc123">
                    </div>
                    <div class="input-group">
                        <label>Accessory Index</label>
                        <input type="number" id="removeAccessoryIndex" placeholder="0">
                    </div>
                </div>
                <button class="btn-danger" onclick="removeAccessory()">Remove Accessory</button>
                <div class="response" id="removeAccessoryResponse"></div>
            </div>

            <!-- Update Accessories -->
            <div class="api-group">
                <h3>PUT /api/concert/:roomId/accessories - Replace All Accessories (JWT Required, Studio Only)</h3>
                <div class="input-group">
                    <label>Room ID</label>
                    <input type="text" id="updateAccessoriesRoomId" placeholder="concert_1234567890_abc123">
                </div>
                <div class="input-group">
                    <label>Accessories JSON Array</label>
                    <textarea id="updateAccessoriesJson" placeholder='[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]'></textarea>
                    <div class="example-box" onclick="copyToInput('updateAccessoriesJson', '[{&quot;socketName&quot;:&quot;head_socket&quot;,&quot;relativeLocation&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;z&quot;:10},&quot;relativeRotation&quot;:{&quot;pitch&quot;:0,&quot;yaw&quot;:0,&quot;roll&quot;:0},&quot;modelUrl&quot;:&quot;/models/hat.glb&quot;}]', this)">[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]</div>
                </div>
                <button class="btn-warning" onclick="updateAccessories()">Update All Accessories</button>
                <div class="response" id="updateAccessoriesResponse"></div>
            </div>
        </div>

        <!-- Accessory Preset APIs -->
        <div class="section">
            <h2>Accessory Preset APIs (Ïï°ÏÑ∏ÏÑúÎ¶¨ ÌîÑÎ¶¨ÏÖã)</h2>

            <!-- Save Preset -->
            <div class="api-group">
                <h3>POST /api/accessory-presets/save - Save Preset (JWT Required)</h3>
                <div class="input-group">
                    <label>Preset Name</label>
                    <input type="text" id="presetName" placeholder="My Preset">
                </div>
                <div class="input-group">
                    <label>Description (Optional)</label>
                    <input type="text" id="presetDescription" placeholder="A cool accessory preset">
                </div>
                <div class="input-group">
                    <label>Accessories JSON Array</label>
                    <textarea id="presetAccessoriesJson" placeholder='[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]'></textarea>
                    <div class="example-box" onclick="copyToInput('presetAccessoriesJson', '[{&quot;socketName&quot;:&quot;head_socket&quot;,&quot;relativeLocation&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;z&quot;:10},&quot;relativeRotation&quot;:{&quot;pitch&quot;:0,&quot;yaw&quot;:0,&quot;roll&quot;:0},&quot;modelUrl&quot;:&quot;/models/hat.glb&quot;}]', this)">[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]</div>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="presetIsPublic"> Public Preset
                    </label>
                </div>
                <button class="btn-primary" onclick="savePreset()">Save Preset</button>
                <div class="response" id="savePresetResponse"></div>
            </div>

            <!-- List Presets -->
            <div class="api-group">
                <h3>GET /api/accessory-presets/list - List Presets (JWT Required)</h3>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="includePublicPresets"> Include Public Presets
                    </label>
                </div>
                <button class="btn-primary" onclick="listPresets()">List Presets</button>
                <div class="response" id="listPresetsResponse"></div>
            </div>

            <!-- Get Preset -->
            <div class="api-group">
                <h3>GET /api/accessory-presets/:id - Get Preset (JWT Required)</h3>
                <div class="input-group">
                    <label>Preset ID</label>
                    <input type="number" id="getPresetId" placeholder="1">
                </div>
                <button class="btn-primary" onclick="getPreset()">Get Preset</button>
                <div class="response" id="getPresetResponse"></div>
            </div>

            <!-- Update Preset -->
            <div class="api-group">
                <h3>PUT /api/accessory-presets/:id - Update Preset (JWT Required)</h3>
                <div class="input-group">
                    <label>Preset ID</label>
                    <input type="number" id="updatePresetId" placeholder="1">
                </div>
                <div class="input-group">
                    <label>Preset Name (Optional)</label>
                    <input type="text" id="updatePresetName" placeholder="Updated Preset">
                </div>
                <div class="input-group">
                    <label>Description (Optional)</label>
                    <input type="text" id="updatePresetDescription" placeholder="Updated description">
                </div>
                <div class="input-group">
                    <label>Accessories JSON Array (Optional)</label>
                    <textarea id="updatePresetAccessoriesJson" placeholder='[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]'></textarea>
                    <div class="example-box" onclick="copyToInput('updatePresetAccessoriesJson', '[{&quot;socketName&quot;:&quot;head_socket&quot;,&quot;relativeLocation&quot;:{&quot;x&quot;:0,&quot;y&quot;:0,&quot;z&quot;:10},&quot;relativeRotation&quot;:{&quot;pitch&quot;:0,&quot;yaw&quot;:0,&quot;roll&quot;:0},&quot;modelUrl&quot;:&quot;/models/hat.glb&quot;}]', this)">[{"socketName":"head_socket","relativeLocation":{"x":0,"y":0,"z":10},"relativeRotation":{"pitch":0,"yaw":0,"roll":0},"modelUrl":"/models/hat.glb"}]</div>
                </div>
                <div class="input-group">
                    <label>
                        <input type="checkbox" id="updatePresetIsPublic"> Public Preset
                    </label>
                </div>
                <button class="btn-warning" onclick="updatePreset()">Update Preset</button>
                <div class="response" id="updatePresetResponse"></div>
            </div>

            <!-- Delete Preset -->
            <div class="api-group">
                <h3>DELETE /api/accessory-presets/:id - Delete Preset (JWT Required)</h3>
                <div class="input-group">
                    <label>Preset ID</label>
                    <input type="number" id="deletePresetId" placeholder="1">
                </div>
                <button class="btn-danger" onclick="deletePreset()">Delete Preset</button>
                <div class="response" id="deletePresetResponse"></div>
            </div>
        </div>
    </div>

    <script>
        let jwtToken = localStorage.getItem('mve_jwt_token') || '';

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateTokenDisplay();
        });

        function updateTokenDisplay() {
            const display = document.getElementById('currentToken');
            if (jwtToken) {
                display.textContent = jwtToken;
            } else {
                display.textContent = 'No token';
            }
        }

        function getLoginServerUrl() {
            return document.getElementById('loginServerUrl').value;
        }

        function getResourceServerUrl() {
            return document.getElementById('resourceServerUrl').value;
        }

        function getAuthHeaders() {
            return jwtToken ? { 'Authorization': `Bearer ${jwtToken}` } : {};
        }

        async function apiCall(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    ...options,
                    headers: {
                        'Content-Type': 'application/json',
                        ...getAuthHeaders(),
                        ...options.headers
                    }
                });
                const data = await response.json();
                const duration = Date.now() - startTime;
                return {
                    status: response.status,
                    statusText: response.statusText,
                    duration: `${duration}ms`,
                    data
                };
            } catch (error) {
                const duration = Date.now() - startTime;
                return {
                    status: 'ERROR',
                    duration: `${duration}ms`,
                    error: error.message
                };
            }
        }

        function displayResponse(elementId, response) {
            document.getElementById(elementId).textContent = JSON.stringify(response, null, 2);
        }

        // Login Server APIs
        async function testLoginHealth() {
            const response = await apiCall(`${getLoginServerUrl()}/health`);
            displayResponse('healthResponse', response);
        }

        async function checkEmail() {
            const email = document.getElementById('checkEmail').value;
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/check-email`, {
                method: 'POST',
                body: JSON.stringify({ email })
            });
            displayResponse('checkEmailResponse', response);
        }

        async function sendVerification() {
            const email = document.getElementById('verifyEmail').value;
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/send-verification`, {
                method: 'POST',
                body: JSON.stringify({ email })
            });
            displayResponse('sendVerificationResponse', response);
        }

        async function verifyCode() {
            const email = document.getElementById('verifyCodeEmail').value;
            const code = document.getElementById('verifyCode').value;
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/verify-code`, {
                method: 'POST',
                body: JSON.stringify({ email, code })
            });
            displayResponse('verifyCodeResponse', response);
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/signup`, {
                method: 'POST',
                body: JSON.stringify({ username, email, password })
            });
            displayResponse('signupResponse', response);
        }

        async function login() {
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/login`, {
                method: 'POST',
                body: JSON.stringify({ username, password })
            });
            displayResponse('loginResponse', response);

            // Save token if login successful
            if (response.data && response.data.token) {
                jwtToken = response.data.token;
                localStorage.setItem('mve_jwt_token', jwtToken);
                updateTokenDisplay();
            }
        }

        async function getProfile() {
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/profile`);
            displayResponse('profileResponse', response);
        }

        async function logout() {
            const response = await apiCall(`${getLoginServerUrl()}/api/auth/logout`, {
                method: 'POST'
            });
            displayResponse('logoutResponse', response);

            if (response.data && response.data.success) {
                jwtToken = '';
                localStorage.removeItem('mve_jwt_token');
                updateTokenDisplay();
            }
        }

        async function withdraw() {
            const password = document.getElementById('withdrawPassword').value;
            if (!password) {
                displayResponse('withdrawResponse', { error: 'Password is required' });
                return;
            }

            if (!confirm('Are you sure you want to delete your account? This action cannot be undone.')) {
                return;
            }

            const response = await apiCall(`${getLoginServerUrl()}/api/auth/withdraw`, {
                method: 'DELETE',
                body: JSON.stringify({ password })
            });
            displayResponse('withdrawResponse', response);

            if (response.data && response.data.success) {
                jwtToken = '';
                localStorage.removeItem('mve_jwt_token');
                updateTokenDisplay();
            }
        }

        // Resource Server APIs
        async function testResourceHealth() {
            const response = await apiCall(`${getResourceServerUrl()}/health`);
            displayResponse('resourceHealthResponse', response);
        }

        async function getAudioList() {
            const response = await apiCall(`${getResourceServerUrl()}/api/audio/list`);
            displayResponse('audioListResponse', response);
        }

        async function getAudioInfo() {
            const id = document.getElementById('audioId').value;
            const response = await apiCall(`${getResourceServerUrl()}/api/audio/${id}`);
            displayResponse('audioInfoResponse', response);
        }

        async function searchAudio() {
            const query = document.getElementById('audioSearchQuery').value;
            const response = await apiCall(`${getResourceServerUrl()}/api/audio/search/${encodeURIComponent(query)}`);
            displayResponse('audioSearchResponse', response);
        }

        async function uploadAudio() {
            const title = document.getElementById('uploadTitle').value;
            const artist = document.getElementById('uploadArtist').value;
            const fileInput = document.getElementById('uploadAudioFile');

            if (!fileInput.files[0]) {
                displayResponse('uploadAudioResponse', { error: 'No file selected' });
                return;
            }

            if (!title) {
                displayResponse('uploadAudioResponse', { error: 'Title is required' });
                return;
            }

            const formData = new FormData();
            formData.append('audio', fileInput.files[0]);
            formData.append('title', title);
            if (artist) formData.append('artist', artist);

            const startTime = Date.now();
            try {
                const response = await fetch(`${getResourceServerUrl()}/api/audio/upload`, {
                    method: 'POST',
                    headers: {
                        ...getAuthHeaders()
                    },
                    body: formData
                });
                const data = await response.json();
                const duration = Date.now() - startTime;
                displayResponse('uploadAudioResponse', {
                    status: response.status,
                    statusText: response.statusText,
                    duration: `${duration}ms`,
                    data
                });
            } catch (error) {
                const duration = Date.now() - startTime;
                displayResponse('uploadAudioResponse', {
                    status: 'ERROR',
                    duration: `${duration}ms`,
                    error: error.message
                });
            }
        }

        async function streamAudio() {
            const id = document.getElementById('streamAudioId').value;
            const startTime = Date.now();
            try {
                const response = await fetch(`${getResourceServerUrl()}/api/audio/stream/${id}`, {
                    headers: getAuthHeaders()
                });
                const duration = Date.now() - startTime;
                const contentType = response.headers.get('content-type');

                // S3 Î™®Îìú: JSON ÏùëÎãµ (presigned URL)
                if (contentType && contentType.includes('application/json')) {
                    const data = await response.json();
                    displayResponse('streamAudioResponse', {
                        status: response.status,
                        statusText: response.statusText,
                        duration: `${duration}ms`,
                        data
                    });
                } else {
                    // Î°úÏª¨ Î™®Îìú: Î∞îÏù¥ÎÑàÎ¶¨ Ïä§Ìä∏Î¶¨Î∞ç
                    displayResponse('streamAudioResponse', {
                        status: response.status,
                        statusText: response.statusText,
                        duration: `${duration}ms`,
                        message: 'Local streaming mode - binary data returned',
                        contentType: contentType,
                        contentLength: response.headers.get('content-length'),
                        streamUrl: `${getResourceServerUrl()}/api/audio/stream/${id}`
                    });
                }
            } catch (error) {
                const duration = Date.now() - startTime;
                displayResponse('streamAudioResponse', {
                    status: 'ERROR',
                    duration: `${duration}ms`,
                    error: error.message
                });
            }
        }

        async function getModelList() {
            const response = await apiCall(`${getResourceServerUrl()}/api/models/list`);
            displayResponse('modelListResponse', response);
        }

        async function getModelInfo() {
            const id = document.getElementById('modelId').value;
            const response = await apiCall(`${getResourceServerUrl()}/api/models/${id}`);
            displayResponse('modelInfoResponse', response);
        }

        async function registerModel() {
            const data = document.getElementById('registerModelData').value;
            try {
                const response = await apiCall(`${getResourceServerUrl()}/api/models/register`, {
                    method: 'POST',
                    body: data
                });
                displayResponse('registerModelResponse', response);
            } catch (e) {
                displayResponse('registerModelResponse', { error: 'Invalid JSON' });
            }
        }

        async function updateModel() {
            const id = document.getElementById('updateModelId').value;
            const data = document.getElementById('updateModelData').value;
            try {
                const response = await apiCall(`${getResourceServerUrl()}/api/models/${id}`, {
                    method: 'PUT',
                    body: data
                });
                displayResponse('updateModelResponse', response);
            } catch (e) {
                displayResponse('updateModelResponse', { error: 'Invalid JSON' });
            }
        }

        async function deleteModel() {
            const id = document.getElementById('deleteModelId').value;
            if (confirm(`Are you sure you want to delete model ${id}?`)) {
                const response = await apiCall(`${getResourceServerUrl()}/api/models/${id}`, {
                    method: 'DELETE'
                });
                displayResponse('deleteModelResponse', response);
            }
        }

        // Concert APIs
        async function createConcert() {
            const concertName = document.getElementById('concertName').value;
            const maxAudience = document.getElementById('concertMaxAudience').value;
            const songsJson = document.getElementById('concertSongsJson').value;
            const accessoriesJson = document.getElementById('concertAccessoriesJson').value;

            if (!concertName) {
                displayResponse('createConcertResponse', { error: 'concertName is required' });
                return;
            }

            const body = {
                concertName
            };

            if (maxAudience) {
                body.maxAudience = parseInt(maxAudience);
            }

            if (songsJson) {
                try {
                    body.songs = JSON.parse(songsJson);
                } catch (e) {
                    displayResponse('createConcertResponse', { error: 'Invalid JSON in songs field' });
                    return;
                }
            }

            if (accessoriesJson) {
                try {
                    body.accessories = JSON.parse(accessoriesJson);
                } catch (e) {
                    displayResponse('createConcertResponse', { error: 'Invalid JSON in accessories field' });
                    return;
                }
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/create`, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            displayResponse('createConcertResponse', response);
        }

        async function listConcerts() {
            const response = await apiCall(`${getResourceServerUrl()}/api/concert/list`);
            displayResponse('listConcertsResponse', response);
        }

        async function joinConcert() {
            const roomId = document.getElementById('joinRoomId').value;
            if (!roomId) {
                displayResponse('joinConcertResponse', { error: 'Room ID is required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/join`, {
                method: 'POST'
            });
            displayResponse('joinConcertResponse', response);
        }

        async function getConcertInfo() {
            const roomId = document.getElementById('infoRoomId').value;
            if (!roomId) {
                displayResponse('concertInfoResponse', { error: 'Room ID is required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/info`);
            displayResponse('concertInfoResponse', response);
        }

        async function addSong() {
            const roomId = document.getElementById('addSongRoomId').value;
            const songNum = document.getElementById('addSongNum').value;
            const audioId = document.getElementById('addSongAudioId').value;
            const streamUrl = document.getElementById('addSongStreamUrl').value;
            const stageDirectionId = document.getElementById('addSongStageDirectionId').value;

            if (!roomId || !songNum || !audioId || !streamUrl || !stageDirectionId) {
                displayResponse('addSongResponse', { error: 'All fields are required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/songs/add`, {
                method: 'POST',
                body: JSON.stringify({
                    songNum: parseInt(songNum),
                    audioId: parseInt(audioId),
                    streamUrl,
                    stageDirectionId: parseInt(stageDirectionId)
                })
            });
            displayResponse('addSongResponse', response);
        }

        async function removeSong() {
            const roomId = document.getElementById('removeSongRoomId').value;
            const songNum = document.getElementById('removeSongNum').value;

            if (!roomId || !songNum) {
                displayResponse('removeSongResponse', { error: 'Room ID and Song Number are required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/songs/${songNum}`, {
                method: 'DELETE'
            });
            displayResponse('removeSongResponse', response);
        }

        async function changeSong() {
            const roomId = document.getElementById('changeSongRoomId').value;
            const songNum = document.getElementById('changeSongNum').value;

            if (!roomId || !songNum) {
                displayResponse('changeSongResponse', { error: 'Room ID and Song Number are required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/songs/change`, {
                method: 'POST',
                body: JSON.stringify({
                    songNum: parseInt(songNum)
                })
            });
            displayResponse('changeSongResponse', response);
        }

        async function getCurrentSong() {
            const roomId = document.getElementById('currentSongRoomId').value;

            if (!roomId) {
                displayResponse('currentSongResponse', { error: 'Room ID is required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/current-song`);
            displayResponse('currentSongResponse', response);
        }

        async function addAccessory() {
            const roomId = document.getElementById('addAccessoryRoomId').value;
            const socketName = document.getElementById('addAccessorySocketName').value;
            const locationX = document.getElementById('addAccessoryLocationX').value;
            const locationY = document.getElementById('addAccessoryLocationY').value;
            const locationZ = document.getElementById('addAccessoryLocationZ').value;
            const rotationPitch = document.getElementById('addAccessoryRotationPitch').value;
            const rotationYaw = document.getElementById('addAccessoryRotationYaw').value;
            const rotationRoll = document.getElementById('addAccessoryRotationRoll').value;
            const modelUrl = document.getElementById('addAccessoryModelUrl').value;

            if (!roomId || !socketName || !modelUrl) {
                displayResponse('addAccessoryResponse', { error: 'Room ID, Socket Name, and Model URL are required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/accessories/add`, {
                method: 'POST',
                body: JSON.stringify({
                    socketName,
                    relativeLocation: {
                        x: parseFloat(locationX) || 0,
                        y: parseFloat(locationY) || 0,
                        z: parseFloat(locationZ) || 0
                    },
                    relativeRotation: {
                        pitch: parseFloat(rotationPitch) || 0,
                        yaw: parseFloat(rotationYaw) || 0,
                        roll: parseFloat(rotationRoll) || 0
                    },
                    modelUrl
                })
            });
            displayResponse('addAccessoryResponse', response);
        }

        async function removeAccessory() {
            const roomId = document.getElementById('removeAccessoryRoomId').value;
            const index = document.getElementById('removeAccessoryIndex').value;

            if (!roomId || index === '') {
                displayResponse('removeAccessoryResponse', { error: 'Room ID and Index are required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/accessories/${index}`, {
                method: 'DELETE'
            });
            displayResponse('removeAccessoryResponse', response);
        }

        async function updateAccessories() {
            const roomId = document.getElementById('updateAccessoriesRoomId').value;
            const accessoriesJson = document.getElementById('updateAccessoriesJson').value;

            if (!roomId) {
                displayResponse('updateAccessoriesResponse', { error: 'Room ID is required' });
                return;
            }

            let accessories;
            try {
                accessories = JSON.parse(accessoriesJson);
                if (!Array.isArray(accessories)) {
                    displayResponse('updateAccessoriesResponse', { error: 'Accessories must be a JSON array' });
                    return;
                }
            } catch (e) {
                displayResponse('updateAccessoriesResponse', { error: 'Invalid JSON in accessories field' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/concert/${roomId}/accessories`, {
                method: 'PUT',
                body: JSON.stringify({ accessories })
            });
            displayResponse('updateAccessoriesResponse', response);
        }

        // Accessory Preset APIs
        async function savePreset() {
            const presetName = document.getElementById('presetName').value;
            const description = document.getElementById('presetDescription').value;
            const accessoriesJson = document.getElementById('presetAccessoriesJson').value;
            const isPublic = document.getElementById('presetIsPublic').checked;

            if (!presetName || !accessoriesJson) {
                displayResponse('savePresetResponse', { error: 'Preset Name and Accessories are required' });
                return;
            }

            let accessories;
            try {
                accessories = JSON.parse(accessoriesJson);
                if (!Array.isArray(accessories)) {
                    displayResponse('savePresetResponse', { error: 'Accessories must be a JSON array' });
                    return;
                }
            } catch (e) {
                displayResponse('savePresetResponse', { error: 'Invalid JSON in accessories field' });
                return;
            }

            const body = {
                presetName,
                accessories,
                isPublic
            };

            if (description) {
                body.description = description;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/accessory-presets/save`, {
                method: 'POST',
                body: JSON.stringify(body)
            });
            displayResponse('savePresetResponse', response);
        }

        async function listPresets() {
            const includePublic = document.getElementById('includePublicPresets').checked;
            const url = `${getResourceServerUrl()}/api/accessory-presets/list${includePublic ? '?includePublic=true' : ''}`;

            const response = await apiCall(url);
            displayResponse('listPresetsResponse', response);
        }

        async function getPreset() {
            const id = document.getElementById('getPresetId').value;

            if (!id) {
                displayResponse('getPresetResponse', { error: 'Preset ID is required' });
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/accessory-presets/${id}`);
            displayResponse('getPresetResponse', response);
        }

        async function updatePreset() {
            const id = document.getElementById('updatePresetId').value;
            const presetName = document.getElementById('updatePresetName').value;
            const description = document.getElementById('updatePresetDescription').value;
            const accessoriesJson = document.getElementById('updatePresetAccessoriesJson').value;
            const isPublic = document.getElementById('updatePresetIsPublic').checked;

            if (!id) {
                displayResponse('updatePresetResponse', { error: 'Preset ID is required' });
                return;
            }

            const body = {};

            if (presetName) body.presetName = presetName;
            if (description) body.description = description;
            if (isPublic !== undefined) body.isPublic = isPublic;

            if (accessoriesJson) {
                try {
                    const accessories = JSON.parse(accessoriesJson);
                    if (!Array.isArray(accessories)) {
                        displayResponse('updatePresetResponse', { error: 'Accessories must be a JSON array' });
                        return;
                    }
                    body.accessories = accessories;
                } catch (e) {
                    displayResponse('updatePresetResponse', { error: 'Invalid JSON in accessories field' });
                    return;
                }
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/accessory-presets/${id}`, {
                method: 'PUT',
                body: JSON.stringify(body)
            });
            displayResponse('updatePresetResponse', response);
        }

        async function deletePreset() {
            const id = document.getElementById('deletePresetId').value;

            if (!id) {
                displayResponse('deletePresetResponse', { error: 'Preset ID is required' });
                return;
            }

            if (!confirm(`Are you sure you want to delete preset ${id}?`)) {
                return;
            }

            const response = await apiCall(`${getResourceServerUrl()}/api/accessory-presets/${id}`, {
                method: 'DELETE'
            });
            displayResponse('deletePresetResponse', response);
        }

        // Copy example to input field
        function copyToInput(inputId, jsonText, element) {
            const textarea = document.getElementById(inputId);
            // HTML entitiesÎ•º Ïã§Ï†ú Î¨∏ÏûêÎ°ú Î≥ÄÌôò
            const decodedText = jsonText.replace(/&quot;/g, '"');
            textarea.value = decodedText;

            // Î≥µÏÇ¨ ÏôÑÎ£å Ïï†ÎãàÎ©îÏù¥ÏÖò
            element.classList.add('copied');
            setTimeout(() => {
                element.classList.remove('copied');
            }, 2000);
        }
    </script>
</body>
</html>
